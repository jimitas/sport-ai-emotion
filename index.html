<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI表情分析体験 - スポーツ×AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        #videoFeed {
            transform: scaleX(-1); /* 自撮り用に反転 */
            width: 100%;
            height: auto;
            background-color: #1f2937;
        }
        .status-badge {
            transition: all 0.3s ease;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

    <!-- 上部メッセージエリア -->
    <header id="headerArea" class="p-6 transition-colors duration-500 bg-blue-600 text-white shadow-md sticky top-0 z-10">
        <div class="max-w-md mx-auto text-center">
            <h1 class="text-sm font-bold opacity-80 mb-1 uppercase tracking-widest">Sport AI Emotion Analysis</h1>
            <div id="resultText" class="text-3xl font-black">カメラを準備してください</div>
            <div id="subText" class="text-xs mt-1 opacity-90">AIがあなたの表情からコンディションを分析します</div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4 gap-6">
        
        <!-- カメラ映像エリア -->
        <div class="w-full max-w-md">
            <div class="video-container bg-black">
                <video id="videoFeed" autoplay playsinline muted></video>
                <!-- 解析中オーバーレイ -->
                <div id="loadingOverlay" class="hidden absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-sm">
                    <div class="flex flex-col items-center">
                        <div class="loading-spinner mb-2"></div>
                        <span class="text-white text-sm font-bold">AI分析中...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- コントロールエリア -->
        <div class="w-full max-w-md flex flex-col gap-4">
            <button id="analyzeBtn" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform disabled:opacity-50">
                表情を分析する
            </button>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-500 mb-2">AIに学習させるポイント:</h3>
                <p class="text-xs text-gray-600 leading-relaxed">
                    スポーツでは「集中」「リラックス」「気合」など、表情がパフォーマンスに影響します。今はどんな状態に見えるかAIに判定させてみましょう。
                </p>
            </div>
        </div>

    </main>

    <!-- 隠しキャンバス（画像キャプチャ用） -->
    <canvas id="captureCanvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('captureCanvas');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const headerArea = document.getElementById('headerArea');
        const resultText = document.getElementById('resultText');
        const subText = document.getElementById('subText');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // 表情ごとのスタイル設定
        const emotionStyles = {
            "笑っている": { color: "bg-yellow-400", sub: "ポジティブな状態です！リラックスできています。" },
            "怒っている": { color: "bg-red-600", sub: "強いエネルギーを感じます。集中力が高まっています。" },
            "泣いている": { color: "bg-blue-800", sub: "ストレスを感じているかもしれません。深呼吸しましょう。" },
            "普通の状態": { color: "bg-green-500", sub: "落ち着いています。安定したパフォーマンスが期待できます。" },
            "不明": { color: "bg-gray-600", sub: "顔がよく見えません。明るい場所で試してください。" }
        };

        // カメラの起動
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                resultText.innerText = "カメラエラー";
                subText.innerText = "ブラウザのカメラ設定を許可してください。";
                console.error(err);
            }
        }

        // 画像をBase64に変換
        function captureImage() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            // 鏡像を元に戻してキャプチャ
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }

        // AI分析の実行
        async function analyzeEmotion() {
            const base64Data = captureImage();
            if (!base64Data) return;

            loadingOverlay.classList.remove('hidden');
            analyzeBtn.disabled = true;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageData: base64Data })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const result = data.emotion || "不明";
                updateUI(result);

            } catch (err) {
                console.error(err);
                resultText.innerText = "エラー";
                subText.innerText = "通信に失敗しました。もう一度試してください。";
            } finally {
                loadingOverlay.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        // UIの更新
        function updateUI(emotion) {
            // 候補にない文字列が返ってきた場合のハンドリング
            let key = "不明";
            if (emotion.includes("笑")) key = "笑っている";
            else if (emotion.includes("怒")) key = "怒っている";
            else if (emotion.includes("泣")) key = "泣いている";
            else if (emotion.includes("普通")) key = "普通の状態";

            const config = emotionStyles[key];
            
            // 背景色のアニメーション変更
            headerArea.className = `p-6 transition-colors duration-500 text-white shadow-md sticky top-0 z-10 ${config.color}`;
            resultText.innerText = key;
            subText.innerText = config.sub;
        }

        // イベントリスナー
        analyzeBtn.addEventListener('click', analyzeEmotion);

        // 起動
        window.onload = initCamera;
    </script>
</body>
</html>