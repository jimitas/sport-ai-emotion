<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¡¨æƒ…åˆ†æä½“é¨“ - ã‚¹ãƒãƒ¼ãƒ„Ã—AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        #videoFeed {
            transform: scaleX(-1); /* è‡ªæ’®ã‚Šç”¨ã«åè»¢ */
            width: 100%;
            height: auto;
            background-color: #1f2937;
        }
        .status-badge {
            transition: all 0.3s ease;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

    <!-- ä¸Šéƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <header id="headerArea" class="p-6 transition-colors duration-500 bg-blue-600 text-white shadow-md sticky top-0 z-10">
        <div class="max-w-md mx-auto text-center">
            <h1 class="text-sm font-bold opacity-80 mb-1 uppercase tracking-widest">Sport AI Emotion Analysis</h1>
            <div id="resultText" class="text-3xl font-black">ã‚«ãƒ¡ãƒ©ã‚’æº–å‚™ã—ã¦ãã ã•ã„</div>
            <div id="subText" class="text-xs mt-1 opacity-90">AIãŒã‚ãªãŸã®è¡¨æƒ…ã‹ã‚‰ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’åˆ†æã—ã¾ã™</div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4 gap-6">
        
        <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒã‚¨ãƒªã‚¢ -->
        <div class="w-full max-w-md">
            <div class="video-container bg-black">
                <video id="videoFeed" autoplay playsinline muted></video>
                <!-- è§£æä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                <div id="loadingOverlay" class="hidden absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-sm">
                    <div class="flex flex-col items-center text-center px-4">
                        <div class="loading-spinner mb-3"></div>
                        <span id="loadingStep" class="text-white text-base font-bold mb-1">å‡¦ç†ä¸­...</span>
                        <span id="loadingDetail" class="text-white text-xs opacity-90">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
        <div class="w-full max-w-md flex flex-col gap-4">
            <button id="analyzeBtn" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform disabled:opacity-50">
                è¡¨æƒ…ã‚’åˆ†æã™ã‚‹
            </button>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-500 mb-2">AIã«å­¦ç¿’ã•ã›ã‚‹ãƒã‚¤ãƒ³ãƒˆ:</h3>
                <p class="text-xs text-gray-600 leading-relaxed">
                    ã‚¹ãƒãƒ¼ãƒ„ã§ã¯ã€Œé›†ä¸­ã€ã€Œãƒªãƒ©ãƒƒã‚¯ã‚¹ã€ã€Œæ°—åˆã€ãªã©ã€è¡¨æƒ…ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã—ã¾ã™ã€‚ä»Šã¯ã©ã‚“ãªçŠ¶æ…‹ã«è¦‹ãˆã‚‹ã‹AIã«åˆ¤å®šã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                </p>
            </div>
        </div>

    </main>

    <!-- éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ç”¨ï¼‰ -->
    <canvas id="captureCanvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('captureCanvas');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const headerArea = document.getElementById('headerArea');
        const resultText = document.getElementById('resultText');
        const subText = document.getElementById('subText');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingStep = document.getElementById('loadingStep');
        const loadingDetail = document.getElementById('loadingDetail');

        // è¡¨æƒ…ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const emotionStyles = {
            "ç¬‘ã£ã¦ã„ã‚‹": { color: "bg-yellow-400", sub: "ãƒã‚¸ãƒ†ã‚£ãƒ–ãªçŠ¶æ…‹ã§ã™ï¼ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã¦ã„ã¾ã™ã€‚" },
            "æ€’ã£ã¦ã„ã‚‹": { color: "bg-red-600", sub: "å¼·ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ„Ÿã˜ã¾ã™ã€‚é›†ä¸­åŠ›ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚" },
            "æ³£ã„ã¦ã„ã‚‹": { color: "bg-blue-800", sub: "ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚æ·±å‘¼å¸ã—ã¾ã—ã‚‡ã†ã€‚" },
            "æ™®é€šã®çŠ¶æ…‹": { color: "bg-green-500", sub: "è½ã¡ç€ã„ã¦ã„ã¾ã™ã€‚å®‰å®šã—ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæœŸå¾…ã§ãã¾ã™ã€‚" },
            "ä¸æ˜": { color: "bg-gray-600", sub: "é¡”ãŒã‚ˆãè¦‹ãˆã¾ã›ã‚“ã€‚æ˜ã‚‹ã„å ´æ‰€ã§è©¦ã—ã¦ãã ã•ã„ã€‚" }
        };

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
        function updateLoadingMessage(step, detail) {
            loadingStep.innerText = step;
            loadingDetail.innerText = detail;
        }

        // ã‚«ãƒ¡ãƒ©ã®èµ·å‹•
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                resultText.innerText = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼";
                subText.innerText = "ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©è¨­å®šã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
                console.error(err);
            }
        }

        // ç”»åƒã‚’Base64ã«å¤‰æ›
        function captureImage() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            // é¡åƒã‚’å…ƒã«æˆ»ã—ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }

        // AIåˆ†æã®å®Ÿè¡Œ
        async function analyzeEmotion() {
            // ã‚¹ãƒ†ãƒƒãƒ—1: ç”»åƒã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            loadingOverlay.classList.remove('hidden');
            analyzeBtn.disabled = true;
            updateLoadingMessage('ğŸ“¸ ç”»åƒã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã„ã¾ã™...', 'ã‚«ãƒ¡ãƒ©ã‹ã‚‰è¡¨æƒ…ã®å†™çœŸã‚’å–å¾—ä¸­');

            await new Promise(resolve => setTimeout(resolve, 300)); // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const base64Data = captureImage();
            if (!base64Data) {
                loadingOverlay.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }

            try {
                // ã‚¹ãƒ†ãƒƒãƒ—2: AIã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                updateLoadingMessage('ğŸš€ AIã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...', 'ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«è»¢é€ã—ã¦ã„ã¾ã™');
                await new Promise(resolve => setTimeout(resolve, 300));

                // ã‚¹ãƒ†ãƒƒãƒ—3: AIåˆ†æ
                updateLoadingMessage('ğŸ¤– AIãŒè¡¨æƒ…ã‚’åˆ†æä¸­...', 'Claude AIãŒé¡”ã®ç‰¹å¾´ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™');

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageData: base64Data })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                // ã‚¹ãƒ†ãƒƒãƒ—4: çµæœã‚’å—ä¿¡
                updateLoadingMessage('âœ¨ çµæœã‚’å—ä¿¡ã—ã¾ã—ãŸï¼', 'åˆ¤å®šçµæœã‚’è¡¨ç¤ºã—ã¾ã™');
                await new Promise(resolve => setTimeout(resolve, 300));

                const data = await response.json();
                const result = data.emotion || "ä¸æ˜";
                updateUI(result);

            } catch (err) {
                console.error(err);
                resultText.innerText = "ã‚¨ãƒ©ãƒ¼";
                subText.innerText = "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
            } finally {
                loadingOverlay.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        // UIã®æ›´æ–°
        function updateUI(emotion) {
            // å€™è£œã«ãªã„æ–‡å­—åˆ—ãŒè¿”ã£ã¦ããŸå ´åˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            let key = "ä¸æ˜";
            if (emotion.includes("ç¬‘")) key = "ç¬‘ã£ã¦ã„ã‚‹";
            else if (emotion.includes("æ€’")) key = "æ€’ã£ã¦ã„ã‚‹";
            else if (emotion.includes("æ³£")) key = "æ³£ã„ã¦ã„ã‚‹";
            else if (emotion.includes("æ™®é€š")) key = "æ™®é€šã®çŠ¶æ…‹";

            const config = emotionStyles[key];
            
            // èƒŒæ™¯è‰²ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´
            headerArea.className = `p-6 transition-colors duration-500 text-white shadow-md sticky top-0 z-10 ${config.color}`;
            resultText.innerText = key;
            subText.innerText = config.sub;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        analyzeBtn.addEventListener('click', analyzeEmotion);

        // èµ·å‹•
        window.onload = initCamera;
    </script>
</body>
</html>